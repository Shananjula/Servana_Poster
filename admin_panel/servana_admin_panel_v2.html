<!DOCTYPE html>
<html lang="en">
<head>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servana Admin Panel - Modernized</title>
    <script src="https://cdn.tailwindcss.com">
    // --- Audit ---
    function renderAudit() {
        const logs = state.audit || [];
        mainContent.innerHTML = `
          <h1 class="text-3xl font-bold mb-4">Admin Audit Log</h1>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-3">
            <input id="auActor" class="border rounded px-3 py-2" placeholder="Actor UID"/>
            <input id="auAction" class="border rounded px-3 py-2" placeholder="Action (e.g., resolve_dispute)"/>
            <input id="auTarget" class="border rounded px-3 py-2" placeholder="Target id (disputeId/batchId)"/>
            <input id="auFrom" class="border rounded px-3 py-2" type="date"/>
            <input id="auTo" class="border rounded px-3 py-2" type="date"/>
          </div>
          <div class="flex gap-2 mb-3">
            <button id="auExport" class="px-3 py-1.5 rounded bg-teal-600 text-white hover:bg-teal-700">Export CSV</button>
          </div>
          <div class="bg-white rounded shadow overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="p-3 text-left">When</th>
                  <th class="p-3 text-left">Actor</th>
                  <th class="p-3 text-left">Action</th>
                  <th class="p-3 text-left">Details</th>
                </tr>
              </thead>
              <tbody id="auRows"></tbody>
            </table>
          </div>`;
        const fActor = document.getElementById('auActor');
        const fAction = document.getElementById('auAction');
        const fTarget = document.getElementById('auTarget');
        const fFrom = document.getElementById('auFrom');
        const fTo = document.getElementById('auTo');
        const tbody = document.getElementById('auRows');

        function filterRows() {
          const a = fActor.value.trim();
          const ac = fAction.value.trim().toLowerCase();
          const tg = fTarget.value.trim().toLowerCase();
          const from = fFrom.value ? new Date(fFrom.value) : null;
          const to = fTo.value ? new Date(fTo.value + 'T23:59:59') : null;

          const rows = (logs || []).filter(m => 
            (!a || (m.actor||'') === a) &&
            (!ac || ((m.action||'').toLowerCase().includes(ac))) &&
            (!tg || JSON.stringify(m).toLowerCase().includes(tg)) &&
            (!from || (m.createdAt?.toDate && m.createdAt.toDate() >= from)) &&
            (!to || (m.createdAt?.toDate && m.createdAt.toDate() <= to))
          );

          tbody.innerHTML = rows.map(m => `
            <tr class="border-t">
              <td class="p-3">${m.createdAt?.toDate ? m.createdAt.toDate().toLocaleString() : ''}</td>
              <td class="p-3 font-mono">${m.actor||''}</td>
              <td class="p-3">${m.action||''}</td>
              <td class="p-3 text-xs">${Object.entries(m).filter(([k]) => !['createdAt','actor','action'].includes(k)).map(([k,v]) => `<div><span class="text-gray-500">${k}:</span> ${typeof v==='object' ? JSON.stringify(v) : v}</div>`).join('')}</td>
            </tr>`).join('') || `<tr><td class="p-6 text-center text-gray-500" colspan="4">No audit entries</td></tr>`;

          document.getElementById('auExport').onclick = () => {
            const header = ['createdAt','actor','action','details'];
            const lines = [header.join(',')].concat(rows.map(m => [
              (m.createdAt?.toDate ? m.createdAt.toDate().toISOString() : ''),
              m.actor||'',
              m.action||'',
              JSON.stringify(m).replace(/,/g,';')
            ].join(',')));
            const blob = new Blob([lines.join('\n')], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'admin_audit.csv'; a.click();
            URL.revokeObjectURL(url);
          };
        }
        [fActor,fAction,fTarget,fFrom,fTo].forEach(el => el.addEventListener('input', filterRows));
        filterRows();
    }
    
</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js">
    // --- Audit ---
    function renderAudit() {
        const logs = state.audit || [];
        mainContent.innerHTML = `
          <h1 class="text-3xl font-bold mb-4">Admin Audit Log</h1>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-3">
            <input id="auActor" class="border rounded px-3 py-2" placeholder="Actor UID"/>
            <input id="auAction" class="border rounded px-3 py-2" placeholder="Action (e.g., resolve_dispute)"/>
            <input id="auTarget" class="border rounded px-3 py-2" placeholder="Target id (disputeId/batchId)"/>
            <input id="auFrom" class="border rounded px-3 py-2" type="date"/>
            <input id="auTo" class="border rounded px-3 py-2" type="date"/>
          </div>
          <div class="flex gap-2 mb-3">
            <button id="auExport" class="px-3 py-1.5 rounded bg-teal-600 text-white hover:bg-teal-700">Export CSV</button>
          </div>
          <div class="bg-white rounded shadow overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="p-3 text-left">When</th>
                  <th class="p-3 text-left">Actor</th>
                  <th class="p-3 text-left">Action</th>
                  <th class="p-3 text-left">Details</th>
                </tr>
              </thead>
              <tbody id="auRows"></tbody>
            </table>
          </div>`;
        const fActor = document.getElementById('auActor');
        const fAction = document.getElementById('auAction');
        const fTarget = document.getElementById('auTarget');
        const fFrom = document.getElementById('auFrom');
        const fTo = document.getElementById('auTo');
        const tbody = document.getElementById('auRows');

        function filterRows() {
          const a = fActor.value.trim();
          const ac = fAction.value.trim().toLowerCase();
          const tg = fTarget.value.trim().toLowerCase();
          const from = fFrom.value ? new Date(fFrom.value) : null;
          const to = fTo.value ? new Date(fTo.value + 'T23:59:59') : null;

          const rows = (logs || []).filter(m => 
            (!a || (m.actor||'') === a) &&
            (!ac || ((m.action||'').toLowerCase().includes(ac))) &&
            (!tg || JSON.stringify(m).toLowerCase().includes(tg)) &&
            (!from || (m.createdAt?.toDate && m.createdAt.toDate() >= from)) &&
            (!to || (m.createdAt?.toDate && m.createdAt.toDate() <= to))
          );

          tbody.innerHTML = rows.map(m => `
            <tr class="border-t">
              <td class="p-3">${m.createdAt?.toDate ? m.createdAt.toDate().toLocaleString() : ''}</td>
              <td class="p-3 font-mono">${m.actor||''}</td>
              <td class="p-3">${m.action||''}</td>
              <td class="p-3 text-xs">${Object.entries(m).filter(([k]) => !['createdAt','actor','action'].includes(k)).map(([k,v]) => `<div><span class="text-gray-500">${k}:</span> ${typeof v==='object' ? JSON.stringify(v) : v}</div>`).join('')}</td>
            </tr>`).join('') || `<tr><td class="p-6 text-center text-gray-500" colspan="4">No audit entries</td></tr>`;

          document.getElementById('auExport').onclick = () => {
            const header = ['createdAt','actor','action','details'];
            const lines = [header.join(',')].concat(rows.map(m => [
              (m.createdAt?.toDate ? m.createdAt.toDate().toISOString() : ''),
              m.actor||'',
              m.action||'',
              JSON.stringify(m).replace(/,/g,';')
            ].join(',')));
            const blob = new Blob([lines.join('\n')], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'admin_audit.csv'; a.click();
            URL.revokeObjectURL(url);
          };
        }
        [fActor,fAction,fTarget,fFrom,fTo].forEach(el => el.addEventListener('input', filterRows));
        filterRows();
    }
    
</script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="">
    // --- Audit ---
    function renderAudit() {
        const logs = state.audit || [];
        mainContent.innerHTML = `
          <h1 class="text-3xl font-bold mb-4">Admin Audit Log</h1>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-3">
            <input id="auActor" class="border rounded px-3 py-2" placeholder="Actor UID"/>
            <input id="auAction" class="border rounded px-3 py-2" placeholder="Action (e.g., resolve_dispute)"/>
            <input id="auTarget" class="border rounded px-3 py-2" placeholder="Target id (disputeId/batchId)"/>
            <input id="auFrom" class="border rounded px-3 py-2" type="date"/>
            <input id="auTo" class="border rounded px-3 py-2" type="date"/>
          </div>
          <div class="flex gap-2 mb-3">
            <button id="auExport" class="px-3 py-1.5 rounded bg-teal-600 text-white hover:bg-teal-700">Export CSV</button>
          </div>
          <div class="bg-white rounded shadow overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="p-3 text-left">When</th>
                  <th class="p-3 text-left">Actor</th>
                  <th class="p-3 text-left">Action</th>
                  <th class="p-3 text-left">Details</th>
                </tr>
              </thead>
              <tbody id="auRows"></tbody>
            </table>
          </div>`;
        const fActor = document.getElementById('auActor');
        const fAction = document.getElementById('auAction');
        const fTarget = document.getElementById('auTarget');
        const fFrom = document.getElementById('auFrom');
        const fTo = document.getElementById('auTo');
        const tbody = document.getElementById('auRows');

        function filterRows() {
          const a = fActor.value.trim();
          const ac = fAction.value.trim().toLowerCase();
          const tg = fTarget.value.trim().toLowerCase();
          const from = fFrom.value ? new Date(fFrom.value) : null;
          const to = fTo.value ? new Date(fTo.value + 'T23:59:59') : null;

          const rows = (logs || []).filter(m => 
            (!a || (m.actor||'') === a) &&
            (!ac || ((m.action||'').toLowerCase().includes(ac))) &&
            (!tg || JSON.stringify(m).toLowerCase().includes(tg)) &&
            (!from || (m.createdAt?.toDate && m.createdAt.toDate() >= from)) &&
            (!to || (m.createdAt?.toDate && m.createdAt.toDate() <= to))
          );

          tbody.innerHTML = rows.map(m => `
            <tr class="border-t">
              <td class="p-3">${m.createdAt?.toDate ? m.createdAt.toDate().toLocaleString() : ''}</td>
              <td class="p-3 font-mono">${m.actor||''}</td>
              <td class="p-3">${m.action||''}</td>
              <td class="p-3 text-xs">${Object.entries(m).filter(([k]) => !['createdAt','actor','action'].includes(k)).map(([k,v]) => `<div><span class="text-gray-500">${k}:</span> ${typeof v==='object' ? JSON.stringify(v) : v}</div>`).join('')}</td>
            </tr>`).join('') || `<tr><td class="p-6 text-center text-gray-500" colspan="4">No audit entries</td></tr>`;

          document.getElementById('auExport').onclick = () => {
            const header = ['createdAt','actor','action','details'];
            const lines = [header.join(',')].concat(rows.map(m => [
              (m.createdAt?.toDate ? m.createdAt.toDate().toISOString() : ''),
              m.actor||'',
              m.action||'',
              JSON.stringify(m).replace(/,/g,';')
            ].join(',')));
            const blob = new Blob([lines.join('\n')], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'admin_audit.csv'; a.click();
            URL.revokeObjectURL(url);
          };
        }
        [fActor,fAction,fTarget,fFrom,fTo].forEach(el => el.addEventListener('input', filterRows));
        filterRows();
    }
    
</script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden-content { display: none; }
        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
            z-index: 50;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal-container {
            transition: all 0.3s ease-in-out;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 42rem;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #14b8a6; /* teal-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .toast {
            transition: all 0.5s ease-in-out;
        }
        .nav-link.active {
            background-color: #ccfbf1; /* teal-100 */
            color: #0d9488; /* teal-700 */
            font-weight: 700;
        }
        #map { height: 600px; }

        .zoomable { cursor: zoom-in; transition: transform 0.2s ease; }
        .zoomable.zoomed { cursor: zoom-out; transform: scale(2); }
        .zoom-wrap { overflow: auto; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div id="auth-container" class="flex items-center justify-center h-screen">
    <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-center text-gray-800">Servana Admin Login</h2>
        <div id="auth-loader" class="flex justify-center items-center flex-col">
            <div class="loader"></div>
            <p id="auth-status-text" class="mt-2 text-gray-500">Initializing...</p>
        </div>
        <div id="firebaseui-auth-container"></div>
    </div>
</div>

<div id="main-app" class="flex h-screen hidden-content">
    <aside class="w-64 bg-white shadow-lg flex flex-col z-10">
        <div class="p-6 text-2xl font-bold text-teal-600 border-b">Servana Admin</div>
        <nav id="sidebar-nav" class="flex-1 p-4 space-y-2">
            <a href="#" data-target="dashboard" class="nav-link flex items-center p-3 text-lg active"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>Dashboard</a>
            <a href="#" data-target="live-map" class="nav-link flex items-center p-3 text-lg text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>Live Map</a>
            <a href="#" data-target="users" class="nav-link flex items-center p-3 text-lg text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A10.004 10.004 0 003 15"></path></svg>Users</a>
            <a href="#" data-target="tasks" class="nav-link flex items-center p-3 text-lg text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>Tasks</a>
            <a href="#" data-target="verification" class="nav-link flex items-center p-3 text-lg text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>Verification</a>
            <a href="#" data-target="interviews" class="nav-link flex items-center p-3 text-lg text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" /></svg>Interviews</a>
            <a href="#" data-target="reports" class="nav-link flex items-center p-3 text-lg text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6H8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path></svg>Reports</a>
            <a href="#" data-target="community-watch" class="nav-link flex items-center p-3 text-lg text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>Community Watch</a>
            <a href="#" data-target="settings" class="nav-link flex items-center p-3 text-lg text-gray-600 hover:bg-gray-100 rounded-lg"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>Settings</a>
        </nav>
        <div class="p-4 border-t">
            <button data-action="logout" class="w-full flex items-center justify-center p-3 text-lg text-red-600 hover:bg-red-100 rounded-lg">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Logout
            </button>
        </div>
    </aside>

    <main id="main-content" class="flex-1 p-8 overflow-y-auto">
    </main>
</div>

<div id="details-modal" class="modal-overlay hidden-content opacity-0" style="z-index: -10;">
    <div class="modal-container transform scale-95">
        <div class="flex justify-between items-center p-4 border-b"><h3 id="modal-title" class="text-2xl font-bold">Details</h3><button data-action="closeModal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div>
        <div id="modal-body" class="p-6 max-h-[70vh] overflow-y-auto"></div>
        <div id="modal-footer" class="p-4 bg-gray-50 border-t text-right space-x-2"></div>
    </div>
</div>

<div id="toast-container" class="fixed top-5 right-5 z-[100] space-y-2 w-full max-w-xs"></div>

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js">
    // --- Audit ---
    function renderAudit() {
        const logs = state.audit || [];
        mainContent.innerHTML = `
          <h1 class="text-3xl font-bold mb-4">Admin Audit Log</h1>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-3">
            <input id="auActor" class="border rounded px-3 py-2" placeholder="Actor UID"/>
            <input id="auAction" class="border rounded px-3 py-2" placeholder="Action (e.g., resolve_dispute)"/>
            <input id="auTarget" class="border rounded px-3 py-2" placeholder="Target id (disputeId/batchId)"/>
            <input id="auFrom" class="border rounded px-3 py-2" type="date"/>
            <input id="auTo" class="border rounded px-3 py-2" type="date"/>
          </div>
          <div class="flex gap-2 mb-3">
            <button id="auExport" class="px-3 py-1.5 rounded bg-teal-600 text-white hover:bg-teal-700">Export CSV</button>
          </div>
          <div class="bg-white rounded shadow overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="p-3 text-left">When</th>
                  <th class="p-3 text-left">Actor</th>
                  <th class="p-3 text-left">Action</th>
                  <th class="p-3 text-left">Details</th>
                </tr>
              </thead>
              <tbody id="auRows"></tbody>
            </table>
          </div>`;
        const fActor = document.getElementById('auActor');
        const fAction = document.getElementById('auAction');
        const fTarget = document.getElementById('auTarget');
        const fFrom = document.getElementById('auFrom');
        const fTo = document.getElementById('auTo');
        const tbody = document.getElementById('auRows');

        function filterRows() {
          const a = fActor.value.trim();
          const ac = fAction.value.trim().toLowerCase();
          const tg = fTarget.value.trim().toLowerCase();
          const from = fFrom.value ? new Date(fFrom.value) : null;
          const to = fTo.value ? new Date(fTo.value + 'T23:59:59') : null;

          const rows = (logs || []).filter(m => 
            (!a || (m.actor||'') === a) &&
            (!ac || ((m.action||'').toLowerCase().includes(ac))) &&
            (!tg || JSON.stringify(m).toLowerCase().includes(tg)) &&
            (!from || (m.createdAt?.toDate && m.createdAt.toDate() >= from)) &&
            (!to || (m.createdAt?.toDate && m.createdAt.toDate() <= to))
          );

          tbody.innerHTML = rows.map(m => `
            <tr class="border-t">
              <td class="p-3">${m.createdAt?.toDate ? m.createdAt.toDate().toLocaleString() : ''}</td>
              <td class="p-3 font-mono">${m.actor||''}</td>
              <td class="p-3">${m.action||''}</td>
              <td class="p-3 text-xs">${Object.entries(m).filter(([k]) => !['createdAt','actor','action'].includes(k)).map(([k,v]) => `<div><span class="text-gray-500">${k}:</span> ${typeof v==='object' ? JSON.stringify(v) : v}</div>`).join('')}</td>
            </tr>`).join('') || `<tr><td class="p-6 text-center text-gray-500" colspan="4">No audit entries</td></tr>`;

          document.getElementById('auExport').onclick = () => {
            const header = ['createdAt','actor','action','details'];
            const lines = [header.join(',')].concat(rows.map(m => [
              (m.createdAt?.toDate ? m.createdAt.toDate().toISOString() : ''),
              m.actor||'',
              m.action||'',
              JSON.stringify(m).replace(/,/g,';')
            ].join(',')));
            const blob = new Blob([lines.join('\n')], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'admin_audit.csv'; a.click();
            URL.revokeObjectURL(url);
          };
        }
        [fActor,fAction,fTarget,fFrom,fTo].forEach(el => el.addEventListener('input', filterRows));
        filterRows();
    }
    
</script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js">
    // --- Audit ---
    function renderAudit() {
        const logs = state.audit || [];
        mainContent.innerHTML = `
          <h1 class="text-3xl font-bold mb-4">Admin Audit Log</h1>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-3">
            <input id="auActor" class="border rounded px-3 py-2" placeholder="Actor UID"/>
            <input id="auAction" class="border rounded px-3 py-2" placeholder="Action (e.g., resolve_dispute)"/>
            <input id="auTarget" class="border rounded px-3 py-2" placeholder="Target id (disputeId/batchId)"/>
            <input id="auFrom" class="border rounded px-3 py-2" type="date"/>
            <input id="auTo" class="border rounded px-3 py-2" type="date"/>
          </div>
          <div class="flex gap-2 mb-3">
            <button id="auExport" class="px-3 py-1.5 rounded bg-teal-600 text-white hover:bg-teal-700">Export CSV</button>
          </div>
          <div class="bg-white rounded shadow overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="p-3 text-left">When</th>
                  <th class="p-3 text-left">Actor</th>
                  <th class="p-3 text-left">Action</th>
                  <th class="p-3 text-left">Details</th>
                </tr>
              </thead>
              <tbody id="auRows"></tbody>
            </table>
          </div>`;
        const fActor = document.getElementById('auActor');
        const fAction = document.getElementById('auAction');
        const fTarget = document.getElementById('auTarget');
        const fFrom = document.getElementById('auFrom');
        const fTo = document.getElementById('auTo');
        const tbody = document.getElementById('auRows');

        function filterRows() {
          const a = fActor.value.trim();
          const ac = fAction.value.trim().toLowerCase();
          const tg = fTarget.value.trim().toLowerCase();
          const from = fFrom.value ? new Date(fFrom.value) : null;
          const to = fTo.value ? new Date(fTo.value + 'T23:59:59') : null;

          const rows = (logs || []).filter(m => 
            (!a || (m.actor||'') === a) &&
            (!ac || ((m.action||'').toLowerCase().includes(ac))) &&
            (!tg || JSON.stringify(m).toLowerCase().includes(tg)) &&
            (!from || (m.createdAt?.toDate && m.createdAt.toDate() >= from)) &&
            (!to || (m.createdAt?.toDate && m.createdAt.toDate() <= to))
          );

          tbody.innerHTML = rows.map(m => `
            <tr class="border-t">
              <td class="p-3">${m.createdAt?.toDate ? m.createdAt.toDate().toLocaleString() : ''}</td>
              <td class="p-3 font-mono">${m.actor||''}</td>
              <td class="p-3">${m.action||''}</td>
              <td class="p-3 text-xs">${Object.entries(m).filter(([k]) => !['createdAt','actor','action'].includes(k)).map(([k,v]) => `<div><span class="text-gray-500">${k}:</span> ${typeof v==='object' ? JSON.stringify(v) : v}</div>`).join('')}</td>
            </tr>`).join('') || `<tr><td class="p-6 text-center text-gray-500" colspan="4">No audit entries</td></tr>`;

          document.getElementById('auExport').onclick = () => {
            const header = ['createdAt','actor','action','details'];
            const lines = [header.join(',')].concat(rows.map(m => [
              (m.createdAt?.toDate ? m.createdAt.toDate().toISOString() : ''),
              m.actor||'',
              m.action||'',
              JSON.stringify(m).replace(/,/g,';')
            ].join(',')));
            const blob = new Blob([lines.join('\n')], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'admin_audit.csv'; a.click();
            URL.revokeObjectURL(url);
          };
        }
        [fActor,fAction,fTarget,fFrom,fTo].forEach(el => el.addEventListener('input', filterRows));
        filterRows();
    }
    
</script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js">
    // --- Audit ---
    function renderAudit() {
        const logs = state.audit || [];
        mainContent.innerHTML = `
          <h1 class="text-3xl font-bold mb-4">Admin Audit Log</h1>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-3">
            <input id="auActor" class="border rounded px-3 py-2" placeholder="Actor UID"/>
            <input id="auAction" class="border rounded px-3 py-2" placeholder="Action (e.g., resolve_dispute)"/>
            <input id="auTarget" class="border rounded px-3 py-2" placeholder="Target id (disputeId/batchId)"/>
            <input id="auFrom" class="border rounded px-3 py-2" type="date"/>
            <input id="auTo" class="border rounded px-3 py-2" type="date"/>
          </div>
          <div class="flex gap-2 mb-3">
            <button id="auExport" class="px-3 py-1.5 rounded bg-teal-600 text-white hover:bg-teal-700">Export CSV</button>
          </div>
          <div class="bg-white rounded shadow overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="p-3 text-left">When</th>
                  <th class="p-3 text-left">Actor</th>
                  <th class="p-3 text-left">Action</th>
                  <th class="p-3 text-left">Details</th>
                </tr>
              </thead>
              <tbody id="auRows"></tbody>
            </table>
          </div>`;
        const fActor = document.getElementById('auActor');
        const fAction = document.getElementById('auAction');
        const fTarget = document.getElementById('auTarget');
        const fFrom = document.getElementById('auFrom');
        const fTo = document.getElementById('auTo');
        const tbody = document.getElementById('auRows');

        function filterRows() {
          const a = fActor.value.trim();
          const ac = fAction.value.trim().toLowerCase();
          const tg = fTarget.value.trim().toLowerCase();
          const from = fFrom.value ? new Date(fFrom.value) : null;
          const to = fTo.value ? new Date(fTo.value + 'T23:59:59') : null;

          const rows = (logs || []).filter(m => 
            (!a || (m.actor||'') === a) &&
            (!ac || ((m.action||'').toLowerCase().includes(ac))) &&
            (!tg || JSON.stringify(m).toLowerCase().includes(tg)) &&
            (!from || (m.createdAt?.toDate && m.createdAt.toDate() >= from)) &&
            (!to || (m.createdAt?.toDate && m.createdAt.toDate() <= to))
          );

          tbody.innerHTML = rows.map(m => `
            <tr class="border-t">
              <td class="p-3">${m.createdAt?.toDate ? m.createdAt.toDate().toLocaleString() : ''}</td>
              <td class="p-3 font-mono">${m.actor||''}</td>
              <td class="p-3">${m.action||''}</td>
              <td class="p-3 text-xs">${Object.entries(m).filter(([k]) => !['createdAt','actor','action'].includes(k)).map(([k,v]) => `<div><span class="text-gray-500">${k}:</span> ${typeof v==='object' ? JSON.stringify(v) : v}</div>`).join('')}</td>
            </tr>`).join('') || `<tr><td class="p-6 text-center text-gray-500" colspan="4">No audit entries</td></tr>`;

          document.getElementById('auExport').onclick = () => {
            const header = ['createdAt','actor','action','details'];
            const lines = [header.join(',')].concat(rows.map(m => [
              (m.createdAt?.toDate ? m.createdAt.toDate().toISOString() : ''),
              m.actor||'',
              m.action||'',
              JSON.stringify(m).replace(/,/g,';')
            ].join(',')));
            const blob = new Blob([lines.join('\n')], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'admin_audit.csv'; a.click();
            URL.revokeObjectURL(url);
          };
        }
        [fActor,fAction,fTarget,fFrom,fTo].forEach(el => el.addEventListener('input', filterRows));
        filterRows();
    }
    
</script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js">
    // --- Audit ---
    function renderAudit() {
        const logs = state.audit || [];
        mainContent.innerHTML = `
          <h1 class="text-3xl font-bold mb-4">Admin Audit Log</h1>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-3">
            <input id="auActor" class="border rounded px-3 py-2" placeholder="Actor UID"/>
            <input id="auAction" class="border rounded px-3 py-2" placeholder="Action (e.g., resolve_dispute)"/>
            <input id="auTarget" class="border rounded px-3 py-2" placeholder="Target id (disputeId/batchId)"/>
            <input id="auFrom" class="border rounded px-3 py-2" type="date"/>
            <input id="auTo" class="border rounded px-3 py-2" type="date"/>
          </div>
          <div class="flex gap-2 mb-3">
            <button id="auExport" class="px-3 py-1.5 rounded bg-teal-600 text-white hover:bg-teal-700">Export CSV</button>
          </div>
          <div class="bg-white rounded shadow overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="p-3 text-left">When</th>
                  <th class="p-3 text-left">Actor</th>
                  <th class="p-3 text-left">Action</th>
                  <th class="p-3 text-left">Details</th>
                </tr>
              </thead>
              <tbody id="auRows"></tbody>
            </table>
          </div>`;
        const fActor = document.getElementById('auActor');
        const fAction = document.getElementById('auAction');
        const fTarget = document.getElementById('auTarget');
        const fFrom = document.getElementById('auFrom');
        const fTo = document.getElementById('auTo');
        const tbody = document.getElementById('auRows');

        function filterRows() {
          const a = fActor.value.trim();
          const ac = fAction.value.trim().toLowerCase();
          const tg = fTarget.value.trim().toLowerCase();
          const from = fFrom.value ? new Date(fFrom.value) : null;
          const to = fTo.value ? new Date(fTo.value + 'T23:59:59') : null;

          const rows = (logs || []).filter(m => 
            (!a || (m.actor||'') === a) &&
            (!ac || ((m.action||'').toLowerCase().includes(ac))) &&
            (!tg || JSON.stringify(m).toLowerCase().includes(tg)) &&
            (!from || (m.createdAt?.toDate && m.createdAt.toDate() >= from)) &&
            (!to || (m.createdAt?.toDate && m.createdAt.toDate() <= to))
          );

          tbody.innerHTML = rows.map(m => `
            <tr class="border-t">
              <td class="p-3">${m.createdAt?.toDate ? m.createdAt.toDate().toLocaleString() : ''}</td>
              <td class="p-3 font-mono">${m.actor||''}</td>
              <td class="p-3">${m.action||''}</td>
              <td class="p-3 text-xs">${Object.entries(m).filter(([k]) => !['createdAt','actor','action'].includes(k)).map(([k,v]) => `<div><span class="text-gray-500">${k}:</span> ${typeof v==='object' ? JSON.stringify(v) : v}</div>`).join('')}</td>
            </tr>`).join('') || `<tr><td class="p-6 text-center text-gray-500" colspan="4">No audit entries</td></tr>`;

          document.getElementById('auExport').onclick = () => {
            const header = ['createdAt','actor','action','details'];
            const lines = [header.join(',')].concat(rows.map(m => [
              (m.createdAt?.toDate ? m.createdAt.toDate().toISOString() : ''),
              m.actor||'',
              m.action||'',
              JSON.stringify(m).replace(/,/g,';')
            ].join(',')));
            const blob = new Blob([lines.join('\n')], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'admin_audit.csv'; a.click();
            URL.revokeObjectURL(url);
          };
        }
        [fActor,fAction,fTarget,fFrom,fTo].forEach(el => el.addEventListener('input', filterRows));
        filterRows();
    }
    
</script>
<script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js">
    // --- Audit ---
    function renderAudit() {
        const logs = state.audit || [];
        mainContent.innerHTML = `
          <h1 class="text-3xl font-bold mb-4">Admin Audit Log</h1>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-3">
            <input id="auActor" class="border rounded px-3 py-2" placeholder="Actor UID"/>
            <input id="auAction" class="border rounded px-3 py-2" placeholder="Action (e.g., resolve_dispute)"/>
            <input id="auTarget" class="border rounded px-3 py-2" placeholder="Target id (disputeId/batchId)"/>
            <input id="auFrom" class="border rounded px-3 py-2" type="date"/>
            <input id="auTo" class="border rounded px-3 py-2" type="date"/>
          </div>
          <div class="flex gap-2 mb-3">
            <button id="auExport" class="px-3 py-1.5 rounded bg-teal-600 text-white hover:bg-teal-700">Export CSV</button>
          </div>
          <div class="bg-white rounded shadow overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="p-3 text-left">When</th>
                  <th class="p-3 text-left">Actor</th>
                  <th class="p-3 text-left">Action</th>
                  <th class="p-3 text-left">Details</th>
                </tr>
              </thead>
              <tbody id="auRows"></tbody>
            </table>
          </div>`;
        const fActor = document.getElementById('auActor');
        const fAction = document.getElementById('auAction');
        const fTarget = document.getElementById('auTarget');
        const fFrom = document.getElementById('auFrom');
        const fTo = document.getElementById('auTo');
        const tbody = document.getElementById('auRows');

        function filterRows() {
          const a = fActor.value.trim();
          const ac = fAction.value.trim().toLowerCase();
          const tg = fTarget.value.trim().toLowerCase();
          const from = fFrom.value ? new Date(fFrom.value) : null;
          const to = fTo.value ? new Date(fTo.value + 'T23:59:59') : null;

          const rows = (logs || []).filter(m => 
            (!a || (m.actor||'') === a) &&
            (!ac || ((m.action||'').toLowerCase().includes(ac))) &&
            (!tg || JSON.stringify(m).toLowerCase().includes(tg)) &&
            (!from || (m.createdAt?.toDate && m.createdAt.toDate() >= from)) &&
            (!to || (m.createdAt?.toDate && m.createdAt.toDate() <= to))
          );

          tbody.innerHTML = rows.map(m => `
            <tr class="border-t">
              <td class="p-3">${m.createdAt?.toDate ? m.createdAt.toDate().toLocaleString() : ''}</td>
              <td class="p-3 font-mono">${m.actor||''}</td>
              <td class="p-3">${m.action||''}</td>
              <td class="p-3 text-xs">${Object.entries(m).filter(([k]) => !['createdAt','actor','action'].includes(k)).map(([k,v]) => `<div><span class="text-gray-500">${k}:</span> ${typeof v==='object' ? JSON.stringify(v) : v}</div>`).join('')}</td>
            </tr>`).join('') || `<tr><td class="p-6 text-center text-gray-500" colspan="4">No audit entries</td></tr>`;

          document.getElementById('auExport').onclick = () => {
            const header = ['createdAt','actor','action','details'];
            const lines = [header.join(',')].concat(rows.map(m => [
              (m.createdAt?.toDate ? m.createdAt.toDate().toISOString() : ''),
              m.actor||'',
              m.action||'',
              JSON.stringify(m).replace(/,/g,';')
            ].join(',')));
            const blob = new Blob([lines.join('\n')], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'admin_audit.csv'; a.click();
            URL.revokeObjectURL(url);
          };
        }
        [fActor,fAction,fTarget,fFrom,fTo].forEach(el => el.addEventListener('input', filterRows));
        filterRows();
    }
    
</script>

<script type="module">
    // --- Firebase Configuration ---
    const firebaseConfig = {
      apiKey: "AIzaSyBS02g3Gtbz_v_cw9KxOffknGQGsvZKK_s",
      authDomain: "helpify-flutter.firebaseapp.com",
      projectId: "helpify-flutter",
      storageBucket: "helpify-flutter.appspot.com",
      messagingSenderId: "657614790732",
      appId: "1:657614790732:web:952d8c55eea79bd77614e9",
      measurementId: "G-L51PN5NVM2"
    };

    // --- Gemini API Configuration ---
    const GEMINI_API_KEY = "AIzaSyBp4DPWJ1VgynLc-4NCcTHMdYJmmQxsnx0";

    // --- Initialize Firebase ---
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    console.log('[Admin] Firebase initialized', firebaseConfig.projectId);
const ui = new firebaseui.auth.AuthUI(auth);

// --- Safety fallback: show FirebaseUI if auth state is slow ---
document.addEventListener('DOMContentLoaded', () => {
  try {
    const ac = document.getElementById('auth-container');
    const uiC = document.getElementById('firebaseui-auth-container');
    const loader = document.getElementById('auth-loader');
    if (ac && uiC && loader) {
      // If main app is hidden and UI area is empty, render the FirebaseUI widget
      const mainApp = document.getElementById('main-app');
      const widgetEmpty = !uiC.hasChildNodes();
      const mainHidden = !mainApp || getComputedStyle(mainApp).display === 'none';
      if (widgetEmpty && mainHidden) {
        ac.style.display = 'flex';
        uiC.style.display = 'block';
        loader.style.display = 'none';
        try {
          // Only start if ui global exists
          if (typeof ui !== 'undefined') {
            ui.start('#firebaseui-auth-container', {
              signInOptions: [{ provider: firebase.auth.PhoneAuthProvider.PROVIDER_ID, defaultCountry: 'LK' }],
              signInSuccessUrl: '#',
              callbacks: { signInSuccessWithAuthResult: () => false }
            });
          }
        } catch (e) { console.warn('UI start fallback failed', e); }
      }
    }
  } catch (e) { console.warn('DOM fallback failed', e); }
});


    // --- Global State & Unsubscribe Listeners ---
    let state = {
        users: [],
        tasks: [],
        verifications: [],
        reports: [],
        interviews: [],
        settings: {}
    };
    let listeners = [];
    let charts = {};
    let mapStuff = { map: null, markers: {} };

    // --- UI Elements ---
    const authContainer = document.getElementById('auth-container');
    const mainApp = document.getElementById('main-app');
    const mainContent = document.getElementById('main-content');
    const sidebarNav = document.getElementById('sidebar-nav');
    const authStatusText = document.getElementById('auth-status-text');

    // --- Toast Notification System ---
    function showToast(message, isError = false) {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;
        const toastId = 'toast-' + Date.now();
        const bgColor = isError ? 'bg-red-600' : 'bg-green-600';
        const toastElement = document.createElement('div');
        toastElement.id = toastId;
        toastElement.className = `toast p-4 text-white rounded-lg shadow-lg transform translate-x-full opacity-0 ${bgColor}`;
        toastElement.textContent = message;
        toastContainer.appendChild(toastElement);
        requestAnimationFrame(() => {
            toastElement.classList.remove('translate-x-full', 'opacity-0');
        });
        setTimeout(() => {
            toastElement.classList.add('opacity-0');
            toastElement.addEventListener('transitionend', () => toastElement.remove());
        }, 4000);
    }

    // --- Auth Handling ---
    let _authFired = false;
    setTimeout(() => {
      try {
        if (!_authFired) {
          const authLoader = document.getElementById('auth-loader');
          const firebaseUiContainer = document.getElementById('firebaseui-auth-container');
          const authStatusText = document.getElementById('auth-status-text');
          if (authStatusText) authStatusText.textContent = 'Connecting took too long. Showing sign-in…';
          if (authLoader) authLoader.style.display = 'none';
          if (firebaseUiContainer) firebaseUiContainer.style.display = 'block';
        }
      } catch (e) { console.warn('auth watchdog failed', e); }
    }, 6000);

    auth.onAuthStateChanged(async (user) => {
        _authFired = true;
        const authLoader = document.getElementById('auth-loader');
        const firebaseUiContainer = document.getElementById('firebaseui-auth-container');
        if (user) {
            authStatusText.textContent = 'Verifying admin status...';
            authLoader.style.display = 'flex';
            firebaseUiContainer.style.display = 'none';
            try {
                const userDocRef = db.collection('users').doc(user.uid);
                const userDoc = await userDocRef.get();
                if (userDoc.exists && userDoc.data().isAdmin === true) {
                    authContainer.style.display = 'none';
                    mainApp.style.display = 'flex';
                    initializeAdminPanel();
                } else {
                    showToast('Access Denied. You are not an administrator.', true);
                    await auth.signOut();
                }
            } catch (error) {
                console.error("Error checking admin status:", error);
                showToast("An error occurred while verifying your admin status.", true);
                await auth.signOut();
            }
        } else {
            cleanupListeners();
            authLoader.style.display = 'none';
            firebaseUiContainer.style.display = 'block';
            authContainer.style.display = 'flex';
            mainApp.style.display = 'none';
            ui.start('#firebaseui-auth-container', {
                signInOptions: [{ provider: firebase.auth.PhoneAuthProvider.PROVIDER_ID, defaultCountry: 'LK' }],
                signInSuccessUrl: '#',
                callbacks: { signInSuccessWithAuthResult: () => false }
            });
        }
    });


    function mergeVerificationLists(oldRequests, newDocs, users) {
        const byId = {};
        const userNameMap = {};
        (users || []).forEach(u => userNameMap[u.id] = u.displayName || u.phoneNumber || 'User');

        (oldRequests || []).forEach(v => {
            const id = v.id || v.userId || v.uid;
            if (!id) return;
            byId[id] = { ...v, id: id, userId: v.userId || id, userName: v.userName || userNameMap[id] };
        });

        (newDocs || []).forEach(doc => {
            const id = doc.id || doc.userId;
            if (!id) return;
            const existing = byId[id] || {};
            const status = doc.status || existing.status || 'pending';
            const submittedAt = doc.resubmittedAt || doc.updatedAt || existing.submittedAt;
            byId[id] = {
                ...existing,
                id,
                userId: id,
                userName: existing.userName || userNameMap[id],
                status,
                submittedAt: submittedAt,
                documents: existing.documents || doc.documents || null,
                // Manually add the fields from the new doc structure
                nicBackUrl: doc.nicBackUrl,
                nicFrontUrl: doc.nicFrontUrl,
                policeUrl: doc.policeUrl,
                selfieUrl: doc.selfieUrl
            };
        });

        return Object.values(byId);
    }

    // --- Diagnostics ---
    window.addEventListener('error', (e) => { try { showToast('JS Error: ' + (e.message || e.error), true); } catch(_){} });
    window.addEventListener('unhandledrejection', (e) => { try { showToast('Promise rejection: ' + (e.reason && e.reason.message ? e.reason.message : e.reason), true); } catch(_){} });

    // --- Verification helpers ---
    async function markVerificationNeedsMoreInfo(userId, keys, requireAll) {
        // keys: array of doc keys to reupload (e.g., ['selfie','nic_front']).
        // If none selected, we mark the whole set.
        const payload = {
            status: 'needs_more_info',
            requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            required: requireAll ? ['all'] : keys
        };
        const txRef = db.collection('verifications').doc(userId);
        try {
            await db.runTransaction(async (transaction) => {
                transaction.set(txRef, payload, { merge: true });
                // If a verification_requests doc exists, update the latest one for this user too.
                const q = await db.collection('verification_requests').where('userId','==', userId).orderBy('submittedAt','desc').limit(1).get();
                if (!q.empty) {
                    transaction.update(q.docs[0].ref, { status: 'needs_more_info', reviewerNote: (requireAll ? 'Please resubmit all documents.' : ('Please reupload: ' + keys.join(', '))), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                }
                // Also mirror to the user document for app UI if needed
                transaction.set(db.collection('users').doc(userId), { verificationStatus: 'needs_more_info', updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
            });
        } catch (e) {
            console.error('markVerificationNeedsMoreInfo failed', e);
            throw e;
        }
    }

    // --- Core Panel Logic ---
    function initializeAdminPanel() {
        showLoaderInContent('Initializing Dashboard...');
        attachRealtimeListeners();
        renderDashboard();
    }

    function attachRealtimeListeners() {
        cleanupListeners();
        const collectionsToListen = {users: db.collection('users').orderBy('createdAt', 'desc'),
            tasks: db.collection('tasks').orderBy('timestamp', 'desc'),
            verifications: db.collection('verification_requests').orderBy('submittedAt', 'desc'),
            reports: db.collection('reports').orderBy('reportedAt', 'desc'),
            interviews: db.collection('interviewRequests').where('status', '==', 'pending').orderBy('requestTimestamp', 'desc'),
            settings: db.collection('settings').doc('platform'),
            verificationsV2: db.collection('verifications').orderBy('updatedAt', 'desc'),
            transactions: db.collection('transactions').orderBy('createdAt', 'desc')};
        Object.keys(collectionsToListen).forEach(key => {
            const ref = collectionsToListen[key];
            const unsub = ref.onSnapshot((snapshot) => {
                if (key === 'settings') {
                    state.settings = snapshot.exists ? snapshot.data() : { commissionRate: 5, freeTaskLimit: 3, referralBonus: 500 };
                } else {
                    state[key] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                const currentView = document.querySelector('.nav-link.active')?.dataset.target || 'dashboard';

                // Normalize verification lists across legacy and new collections
                try {
                    state.verifications = mergeVerificationLists(state.verifications, state.verificationsV2, state.users);
                } catch (e) { console.warn('merge verifications failed', e); }

                renderView(currentView);
            }, (error) => {
                console.error(`Error listening to ${key}:`, error);
                showToast(`Failed to load real-time data for ${key}.`, true);
            });
            listeners.push(unsub);
        });
    }

    function cleanupListeners() {
        listeners.forEach(unsub => unsub());
        listeners = [];
        Object.values(charts).forEach(chart => chart.destroy());
        charts = {};
        if (mapStuff.map) {
            mapStuff.map.remove();
            mapStuff.map = null;
            mapStuff.markers = {};
        }
    }

    // --- Navigation ---
    sidebarNav.addEventListener('click', (event) => {
        const link = event.target.closest('.nav-link');
        if (!link) return;
        event.preventDefault();
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        const target = link.dataset.target;
        renderView(target, true);
    });

    function renderView(view, showLoader = false) {
        if (showLoader) {
            showLoaderInContent(`Loading ${view}...`);
        }
        setTimeout(() => {
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            if (view !== 'live-map' && mapStuff.map) {
                 mapStuff.map.remove();
                 mapStuff.map = null;
                 mapStuff.markers = {};
            }
            switch(view) {
                case 'dashboard': renderDashboard(); break;
                case 'live-map': renderLiveMap(); break;
                case 'users': renderUsers(); break;
                case 'tasks': renderTasks(); break;
                case 'verification': renderVerifications(); break;
                case 'interviews': renderInterviews(); break;
                case 'reports': renderReports(); break;
                case 'community-watch': renderCommunityWatch(); break;
                case 'settings': renderSettings(); break;
            }
        }, showLoader ? 50 : 0);
    }

    // --- Render Functions ---
    function renderDashboard() {
        const pendingVerifications = state.verifications.filter(v => ['pending','pending_review'].includes(v.status)).length;
        const pendingReports = state.reports.filter(r => r.status === 'pending').length;
        const completedTasks = state.tasks.filter(t => t.status === 'completed').length;
        const totalRevenue = state.tasks.reduce((acc, task) => acc + (task.commission || 0), 0);

        mainContent.innerHTML = `
            <h1 class="text-4xl font-bold mb-4">Analytics Dashboard</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                ${createStatCard('Total Users', state.users.length, 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A10.004 10.004 0 003 15', 'teal')}
                ${createStatCard('Total Tasks', state.tasks.length, 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2', 'sky')}
                ${createStatCard('Pending Verifications', pendingVerifications, 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z', 'amber')}
                ${createStatCard('Pending Reports', pendingReports, 'M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6H8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9', 'red')}
                ${createStatCard('Completed Tasks', completedTasks, 'M5 13l4 4L19 7', 'green')}
                ${createStatCard('Total Revenue (LKR)', totalRevenue.toFixed(2), 'M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z', 'indigo')}
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4">User Growth (Last 30 Days)</h3>
                    <div class="relative" style="height: 350px;"><canvas id="userGrowthChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4">Task Growth (Last 30 Days)</h3>
                    <div class="relative" style="height: 350px;"><canvas id="taskGrowthChart"></canvas></div>
                </div>
            </div>`;
        setTimeout(() => {
            renderUserGrowthChart();
            renderTaskGrowthChart();
        }, 0);
    }

    function renderUserGrowthChart() {
        const ctx = document.getElementById('userGrowthChart')?.getContext('2d');
        if (!ctx) return;

        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        const recentUsers = state.users.filter(user => user.createdAt && user.createdAt.toDate() > thirtyDaysAgo);

        const userCountsByDay = {};
        for (let i = 0; i < 30; i++) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const formattedDate = date.toISOString().split('T')[0]; // YYYY-MM-DD
            userCountsByDay[formattedDate] = 0;
        }

        recentUsers.forEach(user => {
            const joinDate = user.createdAt.toDate().toISOString().split('T')[0];
            if (userCountsByDay[joinDate] !== undefined) {
                userCountsByDay[joinDate]++;
            }
        });

        const labels = Object.keys(userCountsByDay).sort();
        const data = labels.map(label => userCountsByDay[label]);

        if (charts.userGrowth) charts.userGrowth.destroy();
        charts.userGrowth = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'New Users',
                    data: data,
                    borderColor: '#0d9488', // teal-700
                    backgroundColor: 'rgba(20, 184, 166, 0.1)', // teal-500 with opacity
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    function renderTaskGrowthChart() {
        const ctx = document.getElementById('taskGrowthChart')?.getContext('2d');
        if (!ctx) return;

        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        const recentTasks = state.tasks.filter(task => task.timestamp && task.timestamp.toDate() > thirtyDaysAgo);
        const taskCountsByDay = {};
        for (let i = 0; i < 30; i++) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            taskCountsByDay[date.toISOString().split('T')[0]] = 0;
        }
        recentTasks.forEach(task => {
            const createdDate = task.timestamp.toDate().toISOString().split('T')[0];
            if (taskCountsByDay[createdDate] !== undefined) {
                taskCountsByDay[createdDate]++;
            }
        });
        const labels = Object.keys(taskCountsByDay).sort();
        const data = labels.map(label => taskCountsByDay[label]);
        if (charts.taskGrowth) charts.taskGrowth.destroy();
        charts.taskGrowth = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'New Tasks',
                    data: data,
                    borderColor: '#38bdf8', // sky-500
                    backgroundColor: 'rgba(56, 189, 248, 0.2)',
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }

    function renderLiveMap() {
        mainContent.innerHTML = `
            <h1 class="text-4xl font-bold mb-4">Helpers Live Map</h1>
            <div class="bg-white p-6 rounded-lg shadow">
                <div id="map" class="rounded-lg"></div>
            </div>
        `;

        setTimeout(() => {
            if (mapStuff.map) return;
            mapStuff.map = L.map('map').setView([7.8731, 80.7718], 8);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(mapStuff.map);

            updateMapMarkers();
        }, 0);
    }

    function updateMapMarkers() {
        if (!mapStuff.map) return;

        const currentMarkerIdsOnMap = { ...mapStuff.markers };

        state.users.forEach(user => {
            if (user.isHelper && user.location && user.location.latitude && user.location.longitude) {
                const latLng = [user.location.latitude, user.location.longitude];

                if (mapStuff.markers[user.id]) {
                    mapStuff.markers[user.id].setLatLng(latLng);
                    delete currentMarkerIdsOnMap[user.id];
                } else {
                    const marker = L.marker(latLng).addTo(mapStuff.map);
                    marker.bindPopup(`<b>${user.displayName || 'Unnamed Helper'}</b><br><button class="mt-2 text-teal-600" data-action="viewUser" data-id="${user.id}">View Profile</button>`);
                    mapStuff.markers[user.id] = marker;
                }
            }
        });

        Object.keys(currentMarkerIdsOnMap).forEach(userId => {
            mapStuff.markers[userId].remove();
            delete mapStuff.markers[userId];
        });
    }

    function renderUsers() {
        mainContent.innerHTML = `
            <div class="flex justify-between items-center mb-4"><h1 class="text-4xl font-bold">User Management</h1></div>
            <div class="bg-white shadow rounded-lg overflow-x-auto">
                <table class="min-w-full leading-normal">
                    <thead class="border-b-2 border-gray-200 bg-gray-100 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">
                        <tr>
                            <th class="px-5 py-3">User</th><th class="px-5 py-3">Phone</th><th class="px-5 py-3">Trust Score</th><th class="px-5 py-3">Status</th><th class="px-5 py-3">Role</th><th class="px-5 py-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body"></tbody>
                </table>
            </div>`;
        const tbody = document.getElementById('user-table-body');
        if (state.users.length === 0) return renderEmptyState(tbody, 6, "No users found.");
        const placeholderAvatar = 'https://placehold.co/40x40/e2e8f0/4a5568?text=U';
        tbody.innerHTML = state.users.map(user => `
            <tr class="border-b border-gray-200 hover:bg-gray-50">
                <td class="px-5 py-4 flex items-center">
                  <img src="${user.photoURL || placeholderAvatar}" onerror="this.onerror=null;this.src='${placeholderAvatar}';" alt="avatar" class="w-10 h-10 rounded-full mr-3 object-cover">
                  <div>
                    <p class="text-gray-900 whitespace-no-wrap">${user.displayName || 'N/A'}</p>
                    <p class="text-gray-600 text-sm">${formatDate(user.createdAt)}</p>
                  </div>
                </td>
                <td class="px-5 py-4">${user.phoneNumber || 'N/A'}</td>
                <td class="px-5 py-4 text-center font-bold text-lg">${user.trustScore || 10}</td>
                <td class="px-5 py-4">${createStatusBadge(user.status || 'active')}</td>
                <td class="px-5 py-4">${createStatusBadge(user.isAdmin ? 'Admin' : (user.isHelper ? 'Helper' : 'User'))}</td>
                <td class="px-5 py-4"><button class="text-teal-600 hover:text-teal-800 font-semibold" data-action="viewUser" data-id="${user.id}">Details</button></td>
            </tr>`).join('');
    }

    function renderTasks() {
        mainContent.innerHTML = `
            <h1 class="text-4xl font-bold mb-8">Task Management</h1>
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <table class="min-w-full leading-normal"><thead class="border-b-2 border-gray-200 bg-gray-100 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider"><tr><th class="px-5 py-3">Task Title</th><th class="px-5 py-3">Posted By</th><th class="px-5 py-3">Budget (LKR)</th><th class="px-5 py-3">Status</th><th class="px-5 py-3">Actions</th></tr></thead><tbody id="task-table-body"></tbody></table>
            </div>`;
        const tbody = document.getElementById('task-table-body');
        if (state.tasks.length === 0) return renderEmptyState(tbody, 5, "No tasks found.");
        tbody.innerHTML = state.tasks.map(task => `
            <tr class="border-b border-gray-200 hover:bg-gray-50">
                <td class="px-5 py-4">${task.title}</td>
                <td class="px-5 py-4">${task.posterName}</td>
                <td class="px-5 py-4 text-right">${(task.budget || 0).toFixed(2)}</td>
                <td class="px-5 py-4">${createStatusBadge(task.status)}</td>
                <td class="px-5 py-4"><button class="text-red-600 hover:text-red-800 font-semibold" data-action="deleteTask" data-id="${task.id}">Delete</button></td>
            </tr>`).join('');
    }

    function renderVerifications() {
         mainContent.innerHTML = `
            <h1 class="text-4xl font-bold mb-8">Verification Hub</h1>
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <table class="min-w-full leading-normal"><thead class="border-b-2 border-gray-200 bg-gray-100 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider"><tr><th class="px-5 py-3">User</th><th class="px-5 py-3">Document Type</th><th class="px-5 py-3">Submitted At</th><th class="px-5 py-3">Status</th><th class="px-5 py-3">Actions</th></tr></thead><tbody id="verification-table-body"></tbody></table>
            </div>`;
        const tbody = document.getElementById('verification-table-body');
        if (state.verifications.length === 0) return renderEmptyState(tbody, 5, "No verification requests.");
        tbody.innerHTML = state.verifications.map(v => `
            <tr class="border-b border-gray-200 hover:bg-gray-50">
                <td class="px-5 py-4">${v.userName || 'N/A'}</td>
                <td class="px-5 py-4">${v.documentType || 'N/A'}</td>
                <td class="px-5 py-4">${formatDate(v.submittedAt)}</td>
                <td class="px-5 py-4">${createStatusBadge(v.status)}</td>
                <td class="px-5 py-4"><button data-action=\"viewVerification\" data-id=\"${v.id}\" class=\"px-3 py-1 rounded bg-teal-50 text-teal-700 hover:bg-teal-100 border border-teal-200\">Review</button></td>
            </tr>`).join('');
    }

    function renderInterviews() {
         mainContent.innerHTML = `
            <h1 class="text-4xl font-bold mb-8">Interview Requests</h1>
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <table class="min-w-full leading-normal"><thead class="border-b-2 border-gray-200 bg-gray-100 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider"><tr><th class="px-5 py-3">User Name</th><th class="px-5 py-3">User ID</th><th class="px-5 py-3">Requested At</th><th class="px-5 py-3">Actions</th></tr></thead><tbody id="interview-table-body"></tbody></table>
            </div>`;
        const tbody = document.getElementById('interview-table-body');
        if (state.interviews.length === 0) return renderEmptyState(tbody, 4, "No pending interview requests.");
        tbody.innerHTML = state.interviews.map(interview => `
            <tr class="border-b border-gray-200 hover:bg-gray-50">
                <td class="px-5 py-4">${interview.userName || 'N/A'}</td>
                <td class="px-5 py-4 text-xs font-mono">${interview.userId}</td>
                <td class="px-5 py-4">${formatDate(interview.requestTimestamp)}</td>
                <td class="px-5 py-4"><button class="text-teal-600 hover:text-teal-800 font-semibold" data-action="viewInterview" data-id="${interview.userId}">Review</button></td>
            </tr>`).join('');
    }

    function renderReports() {
        mainContent.innerHTML = `
            <h1 class="text-4xl font-bold mb-8">Content Reports</h1>
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <table class="min-w-full leading-normal"><thead class="border-b-2 border-gray-200 bg-gray-100 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider"><tr><th class="px-5 py-3">Reported Item</th><th class="px-5 py-3">Type</th><th class="px-5 py-3">Reason</th><th class="px-5 py-3">Reported By</th><th class="px-5 py-3">Status</th><th class="px-5 py-3">Actions</th></tr></thead><tbody id="report-table-body"></tbody></table>
            </div>`;
        const tbody = document.getElementById('report-table-body');
        if (state.reports.length === 0) return renderEmptyState(tbody, 6, "No reports found.");
        tbody.innerHTML = state.reports.map(r => `
            <tr class="border-b border-gray-200 hover:bg-gray-50">
                <td class="px-5 py-4">${r.contentSnippet || r.reportedContentId}</td>
                <td class="px-5 py-4">${r.contentType}</td>
                <td class="px-5 py-4">${r.reason}</td>
                <td class="px-5 py-4">${r.reporterName}</td>
                <td class="px-5 py-4">${createStatusBadge(r.status)}</td>
                <td class="px-5 py-4"><button data-action="viewReport" data-id="${r.id}" class="px-3 py-1 rounded bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200">Review</button></td>
            </tr>`).join('');
    }

    function renderCommunityWatch() {
        mainContent.innerHTML = `
            <h1 class="text-4xl font-bold mb-4">Community Watch</h1>
            <p class="text-gray-600 mb-6">Use AI to scan text for inappropriate content. This requires a configured Gemini API Key.</p>
            <div class="bg-white p-6 rounded-lg shadow">
                <textarea id="community-watch-input" class="w-full h-40 p-3 border rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="Paste text here to scan..."></textarea>
                <div class="text-right mt-4">
                    <button data-action="scanContent" class="px-6 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700">Scan Content</button>
                </div>
                <div id="scan-result-container" class="mt-6 hidden-content">
                    <h3 class="text-xl font-bold mb-2">Scan Result:</h3>
                    <div id="scan-result-loader" class="loader hidden-content"></div>
                    <div id="scan-result-output" class="p-4 border rounded-lg bg-gray-50"></div>
                </div>
            </div>`;
    }

    function renderSettings() {
        mainContent.innerHTML = `
            <h1 class="text-4xl font-bold mb-4">Platform Settings</h1>
            <p class="text-gray-600 mb-6">Configure global settings for the Helpify platform.</p>
            <div class="bg-white p-6 rounded-lg shadow max-w-2xl">
                <div class="space-y-6">
                    <div>
                        <label for="commission-rate" class="block text-sm font-medium text-gray-700">Commission Rate (%)</label>
                        <input type="number" id="commission-rate" value="${state.settings.commissionRate || 0}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="free-task-limit" class="block text-sm font-medium text-gray-700">Free Task Posting Limit</label>
                        <input type="number" id="free-task-limit" value="${state.settings.freeTaskLimit || 0}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="referral-bonus" class="block text-sm font-medium text-gray-700">Referral Bonus (LKR)</label>
                        <input type="number" id="referral-bonus" value="${state.settings.referralBonus || 0}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                <div class="text-right mt-8">
                    <button data-action="saveSettings" class="px-6 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700">Save Settings</button>
                </div>
            </div>`;
    }


    async function tryLoadStorageDocs(userId) {
        try {
            const storage = firebase.storage();
            const base = `verification_documents/${userId}/`;
            const names = ['selfie.jpg','nic_front.jpg','nic_back.jpg','police.jpg'];
            const urls = [];
            for (const name of names) {
                try {
                    const url = await storage.ref(base + name).getDownloadURL();
                    urls.push({ key: name.replace('.jpg',''), url });
                } catch (_) {}
            }
            return urls;
        } catch (e) {
            console.warn('Storage not available or failed', e);
            return [];
        }
    }

    // --- Action Handlers ---
    async function handleUserAction(userId, userAction) {
        const userRef = db.collection("users").doc(userId);
        try {
            switch(userAction) {
                case 'suspend':
                    await userRef.update({ status: 'suspended' });
                    showToast('User has been suspended.');
                    break;
                case 'unsuspend':
                    await userRef.update({ status: 'active' });
                    showToast('User has been re-activated.');
                    break;
                case 'makeAdmin':
                    await userRef.update({ isAdmin: true });
                    showToast('User is now an admin.');
                    break;
                case 'removeAdmin':
                    await userRef.update({ isAdmin: false });
                    showToast('User is no longer an admin.');
                    break;
            }
            hideModal();
        } catch (error) {
            console.error(`Error performing action ${userAction}:`, error);
            showToast(`Failed to ${userAction} user.`, true);
        }
    }

    async function handleVerificationAction(userId, newStatus) {
        const verification = state.verifications.find(v => v.userId === userId);
        if (!verification) {
            showToast('Could not find verification details for this user.', true);
            return;
        }

        try {
            // Find the legacy request document *before* the transaction
            const legacyRequestQuery = db.collection('verification_requests').where('userId', '==', userId).orderBy('submittedAt', 'desc').limit(1);
            const legacySnapshot = await legacyRequestQuery.get();
            const legacyRequestRef = !legacySnapshot.empty ? legacySnapshot.docs[0].ref : null;

            await db.runTransaction(async (transaction) => {
                const userRef = db.collection("users").doc(userId);
                const verificationV2Ref = db.collection("verifications").doc(userId);

                // Update the main user and new verification docs
                transaction.set(verificationV2Ref, { status: newStatus, reviewedAt: firebase.firestore.FieldValue.serverTimestamp(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });

                if (newStatus === 'approved') {
                    let scoreIncrement = 10;
                    let verificationLevel = 'bronze';
                    if (verification.nicFrontUrl || (verification.documents && verification.documents.nicFrontUrl)) {
                        scoreIncrement = 25;
                        verificationLevel = 'silver';
                    }
                    if (verification.policeUrl || (verification.documents && verification.documents.policeClearanceUrl)) {
                        scoreIncrement = 40;
                        verificationLevel = 'gold';
                    }
                    transaction.update(userRef, {
                        isHelper: true,
                        verificationStatus: 'verified',
                        trustScore: firebase.firestore.FieldValue.increment(scoreIncrement),
                        verificationLevel: verificationLevel
                    });
                } else if (newStatus === 'rejected') {
                    transaction.update(userRef, { verificationStatus: 'rejected' });
                }

                // If a legacy request was found, update it within the same transaction
                if (legacyRequestRef) {
                    transaction.update(legacyRequestRef, { status: newStatus, reviewedAt: firebase.firestore.FieldValue.serverTimestamp() });
                }
            });
            hideModal();
            showToast(`Request has been successfully ${newStatus}.`);
        } catch (error) {
            console.error("Error handling verification:", error);
            showToast(`Failed to update status: ${error.message}`, true);
        }
    }

    // Replace the old handleInterviewAction function with this one
    async function handleInterviewAction(userId, action) {
        const interviewRef = db.collection("interviewRequests").doc(userId);
        const userRef = db.collection("users").doc(userId);
        try {
            const batch = db.batch();
            if (action === 'complete') {
                // Get the score from the input field in the modal
                const score = Number(document.getElementById('interview-score')?.value || 0);

                batch.update(interviewRef, { status: 'completed' });
                batch.update(userRef, {
                    interviewStatus: 'completed',
                    interviewScore: score, // Save the score
                    badges: firebase.firestore.FieldValue.arrayUnion('Pro Helper'), // Add the badge
                    trustScore: firebase.firestore.FieldValue.increment(50),
                });
                showToast('Interview marked as complete. User awarded "Pro Helper" badge.');

            } else if (action === 'dismiss') {
                batch.update(interviewRef, { status: 'dismissed' });
                batch.update(userRef, { interviewStatus: 'none' });
                showToast('Interview request dismissed.');
            }
            await batch.commit();
            hideModal();
        } catch (error) {
            console.error(`Error performing action ${action}:`, error);
            showToast(`Failed to ${action} interview request.`, true);
        }
    }

    async function handleReportAction(reportId, action) {
        const reportRef = db.collection("reports").doc(reportId);
        const report = state.reports.find(r => r.id === reportId);
        if (!report) return;

        try {
            const batch = db.batch();
            batch.update(reportRef, { status: 'resolved', resolvedAt: firebase.firestore.FieldValue.serverTimestamp() });

            if (action === 'dismiss') {
                showToast('Report dismissed.');
            } else if (action === 'deleteContentAndSuspend') {
                const contentRef = db.collection(report.contentType === 'task' ? 'tasks' : 'users').doc(report.reportedContentId);
                batch.delete(contentRef);
                const userRef = db.collection("users").doc(report.reportedUserId);
                batch.update(userRef, { status: 'suspended' });
                showToast('Content deleted and user suspended.');
            }
            await batch.commit();
            hideModal();
        } catch (error) {
            console.error("Error resolving report:", error);
            showToast('Failed to resolve report.', true);
        }
    }

    // --- Utility Functions ---
    const formatDate = (timestamp) => {
        if (!timestamp || typeof timestamp.toDate !== 'function') return '...';
        return timestamp.toDate().toLocaleDateString('en-LK', { year: 'numeric', month: 'short', day: 'numeric' });
    };

    const createStatusBadge = (status) => {
        const statusText = String(status || 'N/A').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        const statusClasses = {
            'Admin': 'bg-purple-100 text-purple-700',
            'Helper': 'bg-indigo-100 text-indigo-700',
            'User': 'bg-gray-100 text-gray-700',
            'Verified': 'bg-green-100 text-green-700',
            'Approved': 'bg-green-100 text-green-700',
            'Pending Review': 'bg-amber-100 text-amber-700',
            'Pending': 'bg-amber-100 text-amber-700',
            'Rejected': 'bg-red-100 text-red-700',
            'Open': 'bg-sky-100 text-sky-700',
            'Completed': 'bg-green-100 text-green-700',
            'In Progress': 'bg-amber-100 text-amber-700',
            'Active': 'bg-green-100 text-green-700',
            'Suspended': 'bg-red-100 text-red-700',
            'Bronze': 'bg-orange-200 text-orange-800',
            'Silver': 'bg-gray-300 text-gray-800',
            'Gold': 'bg-yellow-200 text-yellow-800',
            'Unverified': 'bg-gray-100 text-gray-700',
        };
        const className = statusClasses[statusText] || 'bg-gray-100 text-gray-700';
        return `<span class="px-2 py-1 text-xs font-semibold rounded-full ${className}">${statusText}</span>`;
    };

    const createStatCard = (title, value, svgPath, color) => {
        const colors = {
            teal: 'bg-teal-100 text-teal-600',
            sky: 'bg-sky-100 text-sky-600',
            amber: 'bg-amber-100 text-amber-600',
            red: 'bg-red-100 text-red-600',
            green: 'bg-green-100 text-green-600',
            indigo: 'bg-indigo-100 text-indigo-600',
        };
        return `
            <div class="bg-white p-6 rounded-lg shadow flex items-center">
                <div class="p-3 rounded-full ${colors[color]} mr-4"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${svgPath}"></path></svg></div>
                <div><h3 class="text-gray-500 text-lg">${title}</h3><p class="text-3xl font-bold">${value}</p></div>
            </div>`;
    };

    const renderEmptyState = (tbody, colSpan, message) => {
        if(tbody) tbody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center p-8 text-gray-500">${message}</td></tr>`;
    };

    const showLoaderInContent = (message = 'Loading...') => {
        mainContent.innerHTML = `<div class="flex flex-col justify-center items-center h-full"><div class="loader"></div><p class="mt-4 text-gray-600">${message}</p></div>`;
    };

    // --- Event Delegation for All Actions ---
    document.body.addEventListener('click', async (event) => {
        const targetElement = event.target.closest('[data-action]');
        if (!targetElement) return;

        const { action, id } = targetElement.dataset;
        if (targetElement.disabled) return;

        switch (action) {
            case 'viewUser':
                const user = state.users.find(u => u.id === id);
                if (!user) return;
                showModal(`User: ${user.displayName || 'N/A'}`,
                    `<div class="space-y-2">
                        <p><strong>Phone:</strong> ${user.phoneNumber || 'N/A'}</p>
                        <p><strong>Trust Score:</strong> <span class="font-bold text-lg">${user.trustScore || '10'}</span></p>
                        <p><strong>Status:</strong> ${createStatusBadge(user.status || 'active')}</p>
                        <p><strong>Role:</strong> ${createStatusBadge(user.isAdmin ? 'Admin' : (user.isHelper ? 'Helper' : 'User'))}</p>
                        <p><strong>Verification Level:</strong> ${createStatusBadge(user.verificationLevel || 'Unverified')}</p>
                    </div>`,
                    `<button data-action="sendNotification" data-id="${id}" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Send Notification</button>
                     <button data-action="${user.isAdmin ? 'removeAdmin' : 'makeAdmin'}" data-id="${id}" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">${user.isAdmin ? 'Remove Admin' : 'Make Admin'}</button>
                     <button data-action="${user.status === 'suspended' ? 'unsuspend' : 'suspend'}" data-id="${id}" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">${user.status === 'suspended' ? 'Un-suspend' : 'Suspend'}</button>`
                );
                break;
            case 'suspend':
            case 'unsuspend':
            case 'makeAdmin':
            case 'removeAdmin':
                handleUserAction(id, action);
                break;

            case 'sendNotification':
                showModal(
                    'Send Notification',
                    `<div class="space-y-4">
                        <div>
                            <label for="notification-title" class="block text-sm font-medium text-gray-700">Title</label>
                            <input type="text" id="notification-title" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Notification Title">
                        </div>
                        <div>
                            <label for="notification-body" class="block text-sm font-medium text-gray-700">Body</label>
                            <textarea id="notification-body" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Notification message..."></textarea>
                        </div>
                    </div>`,
                    `<button data-action="closeModal" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                     <button data-action="confirmSendNotification" data-id="${id}" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Send</button>`
                );
                break;

            case 'confirmSendNotification':
                const title = document.getElementById('notification-title')?.value;
                const body = document.getElementById('notification-body')?.value;
                if (title && body) {
                    try {
                        targetElement.disabled = true;
                        targetElement.textContent = 'Sending...';
                        const notificationsRef = db.collection(`users/${id}/notifications`);
                        await notificationsRef.add({ title, body, read: false, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                        showToast('Notification sent successfully.');
                        hideModal();
                    } catch (error) {
                        showToast('Failed to send notification.', true);
                        console.error("Error sending notification:", error);
                        hideModal();
                    }
                } else {
                    showToast('Title and body cannot be empty.', true);
                }
                break;
            case 'deleteTask':
                showModal(
                    'Confirm Deletion',
                    `<p>Are you sure you want to delete this task? This action cannot be undone.</p>`,
                    `<button data-action="closeModal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                     <button data-action="confirmDeleteTask" data-id="${id}" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete Task</button>`
                );
                break;
            case 'confirmDeleteTask':
                 try {
                     targetElement.disabled = true;
                     targetElement.textContent = 'Deleting...';
                     await db.collection('tasks').doc(id).delete();
                     showToast('Task deleted successfully.');
                     hideModal();
                 } catch (error) {
                     showToast('Failed to delete task.', true);
                     console.error("Error deleting task:", error);
                     hideModal();
                 }
                break;
            case 'viewVerification':
                const verification = state.verifications.find(v => v.id === id);
                if (!verification) return;

                const docUrls = {
                    selfieUrl: verification.selfieUrl,
                    nicFrontUrl: verification.nicFrontUrl,
                    nicBackUrl: verification.nicBackUrl,
                    policeUrl: verification.policeUrl,
                    ...verification.documents
                };

                let imagesHTML = Object.keys(docUrls).map(key => {
                    const url = docUrls[key];
                    if (!url) return '';
                    const title = key.replace(/([A-Z])/g, ' $1').replace('Url', '').replace(/^./, str => str.toUpperCase());
                    return `<div class="mb-4">
                                <p class="font-semibold">${title}:</p>
                                <a href="${url}" target="_blank" rel="noopener noreferrer">
                                    <img src="${url}" alt="${title}" class="w-full h-auto rounded-lg border mt-1"/>
                                </a>
                            </div>`;
                }).join('');

                if (!imagesHTML) {
                     imagesHTML = '<p class="text-gray-500">No documents found in this request.</p>';
                }


                showModal('Review Verification',
                    `<p><strong>User:</strong> ${verification.userName} (${verification.userId})</p>
                     <p><strong>Document Type:</strong> ${verification.documentType || 'N/A'}</p>
                     <p><strong>Submitted:</strong> ${formatDate(verification.submittedAt)}</p>
                     <div class="mt-4">${imagesHTML}</div>`,
                    `<button data-action="rejectVerification" data-id="${id}" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Reject</button>
                     <button data-action="requestReupload" data-id="${verification.userId}" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 mr-2">Request reupload</button>
                     <button data-action="approveVerification" data-id="${id}" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Approve</button>`
                );
                break;
            case 'requestReupload':
                targetElement.disabled = true;
                targetElement.textContent = 'Requesting...';
                try {
                    const selected = Array.from(document.querySelectorAll('.reupload-check:checked')).map(el => el.value);
                    const requireAll = selected.length === 0;
                    await markVerificationNeedsMoreInfo(id, selected, requireAll);
                    showToast(requireAll ? 'Requested full resubmission.' : ('Requested reupload of: ' + selected.join(', ')));
                    hideModal();
                } catch (err) {
                    console.error(err);
                    showToast('Failed to request reupload.', true);
                    targetElement.disabled = false;
                    targetElement.textContent = 'Request reupload';
                }
                break;
            case 'approveVerification':
            case 'rejectVerification':
                targetElement.disabled = true;
                targetElement.textContent = 'Processing...';
                const verificationForAction = state.verifications.find(v => v.id === id);
                if (verificationForAction && verificationForAction.userId) {
                    const newStatus = action === 'approveVerification' ? 'approved' : 'rejected';
                    await handleVerificationAction(verificationForAction.userId, newStatus);
                } else {
                     showToast('Could not find user for this verification.', true);
                     targetElement.disabled = false;
                     targetElement.textContent = action === 'approveVerification' ? 'Approve' : 'Reject';
                }
                break;
            // Replace the old 'viewInterview' case with this one
            case 'viewInterview':
                const interview = state.interviews.find(i => i.userId === id);
                const userForInterview = state.users.find(u => u.id === id);
                if (!interview || !userForInterview) return;
                showModal(`Interview Request: ${userForInterview.displayName}`,
                    `<div class="space-y-4">
                        <div>
                            <p><strong>User Name:</strong> ${userForInterview.displayName}</p>
                            <p><strong>Phone:</strong> ${userForInterview.phoneNumber || 'N/A'}</p>
                            <p><strong>Requested At:</strong> ${formatDate(interview.requestTimestamp)}</p>
                            <a href="#" data-action="viewUser" data-id="${id}" class="text-teal-600 font-semibold hover:underline">View Full User Profile &rarr;</a>
                        </div>
                        <div>
                            <label for="interview-score" class="block text-sm font-medium text-gray-700">Interview Score (out of 100)</label>
                            <input type="number" id="interview-score" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., 85">
                        </div>
                    </div>`,
                    `<button data-action="dismissInterview" data-id="${id}" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Dismiss</button>
                     <button data-action="completeInterview" data-id="${id}" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Mark as Completed</button>`
                );
                break;
            case 'completeInterview':
                await handleInterviewAction(id, 'complete');
                break;
            case 'dismissInterview':
                await handleInterviewAction(id, 'dismiss');
                break;
            case 'viewReport':
                const report = state.reports.find(r => r.id === id);
                if (!report) return;
                showModal('Review Report',
                    `<div>
                        <p><strong>Reported Item:</strong> ${report.contentSnippet || report.reportedContentId}</p>
                        <p><strong>Reason:</strong> ${report.reason}</p>
                        <p><strong>Reported By:</strong> ${report.reporterName} (${report.reporterId})</p>
                        <p><strong>Reported At:</strong> ${formatDate(report.reportedAt)}</p>
                    </div>`,
                    `<button data-action="dismissReport" data-id="${id}" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Dismiss</button>
                     <button data-action="deleteContentAndSuspend" data-id="${id}" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete Content & Suspend User</button>`
                );
                break;
            case 'dismissReport':
                await handleReportAction(id, 'dismiss');
                break;
            case 'deleteContentAndSuspend':
                await handleReportAction(id, 'deleteContentAndSuspend');
                break;
            case 'scanContent':
                const input = document.getElementById('community-watch-input').value;
                const resultContainer = document.getElementById('scan-result-container');
                const resultLoader = document.getElementById('scan-result-loader');
                const resultOutput = document.getElementById('scan-result-output');

                if (!input) {
                    showToast('Please enter text to scan.', true);
                    return;
                }
                if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
                    showToast('Gemini API Key is not configured.', true);
                    return;
                }

                resultContainer.style.display = 'block';
                resultLoader.style.display = 'block';
                resultOutput.style.display = 'none';

                try {
                    const prompt = `Analyze the following text for harmful content (like hate speech, harassment, violence, or explicit content). Respond with a single word: "Safe" or "Unsafe". Text: "${input}"`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) {
                         const errorBody = await response.text();
                         throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody}`);
                    }
                    const result = await response.json();
                    const text = result.candidates[0].content.parts[0].text.trim();
                    resultOutput.textContent = `Result: ${text}`;
                    resultOutput.className = `p-4 border rounded-lg ${text.includes('Unsafe') ? 'bg-red-100 border-red-300' : 'bg-green-100 border-green-300'}`;
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    resultOutput.textContent = `Error: ${error.message}`;
                    resultOutput.className = 'p-4 border rounded-lg bg-red-100 border-red-300';
                } finally {
                    resultLoader.style.display = 'none';
                    resultOutput.style.display = 'block';
                }
                break;
            case 'saveSettings':
                try {
                    targetElement.disabled = true;
                    targetElement.textContent = 'Saving...';
                    const settingsRef = db.collection("settings").doc("platform");
                    const newSettings = {
                        commissionRate: Number(document.getElementById('commission-rate').value),
                        freeTaskLimit: Number(document.getElementById('free-task-limit').value),
                        referralBonus: Number(document.getElementById('referral-bonus').value)
                    };
                    await settingsRef.set(newSettings, { merge: true });
                    showToast('Settings saved successfully.');
                } catch (error) {
                    console.error("Error saving settings:", error);
                    showToast('Failed to save settings.', true);
                } finally {
                    targetElement.disabled = false;
                    targetElement.textContent = 'Save Settings';
                }
                break;
            case 'closeModal':
                hideModal();
                break;
            case 'logout':
                await auth.signOut();
                break;
        }
    });

    // --- Modal Logic ---
    const modal = document.getElementById('details-modal');
    function showModal(title, content, footerContent = '') {
        modal.querySelector('#modal-title').innerHTML = title;
        modal.querySelector('#modal-body').innerHTML = content;
        modal.querySelector('#modal-footer').innerHTML = footerContent || `<button data-action="closeModal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Close</button>`;
        modal.style.zIndex = 50;
        modal.classList.remove('hidden-content');
        requestAnimationFrame(() => {
            modal.classList.remove('opacity-0');
            modal.querySelector('.modal-container').classList.remove('scale-95');
        });
    }
    function hideModal() {
        modal.classList.add('opacity-0');
        modal.querySelector('.modal-container').classList.add('scale-95');
        setTimeout(() => {
            modal.classList.add('hidden-content');
            modal.style.zIndex = -10;
        }, 300);
    }

    // --- Audit ---
    function renderAudit() {
        const logs = state.audit || [];
        mainContent.innerHTML = `
          <h1 class="text-3xl font-bold mb-4">Admin Audit Log</h1>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-3">
            <input id="auActor" class="border rounded px-3 py-2" placeholder="Actor UID"/>
            <input id="auAction" class="border rounded px-3 py-2" placeholder="Action (e.g., resolve_dispute)"/>
            <input id="auTarget" class="border rounded px-3 py-2" placeholder="Target id (disputeId/batchId)"/>
            <input id="auFrom" class="border rounded px-3 py-2" type="date"/>
            <input id="auTo" class="border rounded px-3 py-2" type="date"/>
          </div>
          <div class="flex gap-2 mb-3">
            <button id="auExport" class="px-3 py-1.5 rounded bg-teal-600 text-white hover:bg-teal-700">Export CSV</button>
          </div>
          <div class="bg-white rounded shadow overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="p-3 text-left">When</th>
                  <th class="p-3 text-left">Actor</th>
                  <th class="p-3 text-left">Action</th>
                  <th class="p-3 text-left">Details</th>
                </tr>
              </thead>
              <tbody id="auRows"></tbody>
            </table>
          </div>`;
        const fActor = document.getElementById('auActor');
        const fAction = document.getElementById('auAction');
        const fTarget = document.getElementById('auTarget');
        const fFrom = document.getElementById('auFrom');
        const fTo = document.getElementById('auTo');
        const tbody = document.getElementById('auRows');

        function filterRows() {
          const a = fActor.value.trim();
          const ac = fAction.value.trim().toLowerCase();
          const tg = fTarget.value.trim().toLowerCase();
          const from = fFrom.value ? new Date(fFrom.value) : null;
          const to = fTo.value ? new Date(fTo.value + 'T23:59:59') : null;

          const rows = (logs || []).filter(m => 
            (!a || (m.actor||'') === a) &&
            (!ac || ((m.action||'').toLowerCase().includes(ac))) &&
            (!tg || JSON.stringify(m).toLowerCase().includes(tg)) &&
            (!from || (m.createdAt?.toDate && m.createdAt.toDate() >= from)) &&
            (!to || (m.createdAt?.toDate && m.createdAt.toDate() <= to))
          );

          tbody.innerHTML = rows.map(m => `
            <tr class="border-t">
              <td class="p-3">${m.createdAt?.toDate ? m.createdAt.toDate().toLocaleString() : ''}</td>
              <td class="p-3 font-mono">${m.actor||''}</td>
              <td class="p-3">${m.action||''}</td>
              <td class="p-3 text-xs">${Object.entries(m).filter(([k]) => !['createdAt','actor','action'].includes(k)).map(([k,v]) => `<div><span class="text-gray-500">${k}:</span> ${typeof v==='object' ? JSON.stringify(v) : v}</div>`).join('')}</td>
            </tr>`).join('') || `<tr><td class="p-6 text-center text-gray-500" colspan="4">No audit entries</td></tr>`;

          document.getElementById('auExport').onclick = () => {
            const header = ['createdAt','actor','action','details'];
            const lines = [header.join(',')].concat(rows.map(m => [
              (m.createdAt?.toDate ? m.createdAt.toDate().toISOString() : ''),
              m.actor||'',
              m.action||'',
              JSON.stringify(m).replace(/,/g,';')
            ].join(',')));
            const blob = new Blob([lines.join('\n')], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'admin_audit.csv'; a.click();
            URL.revokeObjectURL(url);
          };
        }
        [fActor,fAction,fTarget,fFrom,fTo].forEach(el => el.addEventListener('input', filterRows));
        filterRows();
    }
    
</script>

</body>
</html>
